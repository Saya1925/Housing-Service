<!DOCTYPE html>
<html>

<head>
    <title>OfferList A</title>
    <!-- <link rel="stylesheet" href="style_offerTemplateA.css"> -->
</head>

<body>
    <span id="sharedDiv">
        <span><u>here are the localStorage session data:</u></span><br>
        <span id="displayStoredSession"></span>
    </span>
    <br><br><br>

    <span><b>targetTaskID:</b></span>
    <input type="text" id="targetTaskID">
    <button id="changeTargetTaskIDButton">Change targetTaskID</button>

    <br>
    <br>
    <!-- <span id="raw_offerListDisplay"></span> -->



    <div id="offerListPanel">
        <div id="offerContainer" class="offer-container">
            <table class="offerContainer">
                <!-- <tr>
                    <td>
                    <td style="width: 145px; vertical-align: top; text-align: right; padding: 10px;">
                        <span id="userName">placeholder</span><br>
                        <span id="rating">placeholder</span>
                    </td>
                    <td style="width: 455px; vertical-align: top; padding: 10px; background-color: #FFFFFF;">
                        <span id="message">placeholder</span>
                    </td>
                    </td>
                </tr> -->
            </table>
        </div>
    </div>

    <!-- <script>
        console.log("current target taskID: " + localStorage.getItem("targetTaskID"));
        var offerContainer = document.getElementById("offerContainer");

        // use the input to change the localStorage.getitem("pro");
        const loadOfferListButton = document.getElementById('loadOfferListButton');
        loadOfferListButton.addEventListener('click', async() => {
            var changeTargetTaskID = document.getElementById("targetTaskID").value;
            localStorage.setItem('targetTaskID', changeTargetTaskID);
            console.log(localStorage.getItem("targetTaskID"));
            taskID = localStorage.getItem("targetTaskID");
            try {
                const response = await fetch(`/getTask/getOfferList?taskID=${taskID}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log(data);
                    console.log(data.length);
                    // for display the raw JSON
                    raw_offerListDisplay.textContent = JSON.stringify(data);

                    // Clear existing content in offerContainer
                    offerContainer.innerHTML = "";

                    // userName.innerHTML = "<b>" + data[0].userName + "</b>";
                    // rating.textContent = data[0].rating;
                    // message.textContent = data[0].message;

                    for (let i = 0; i < data.length; i++) {
                        const offerBlock = document.createElement('div');
                        offerBlock.classList.add('offer');

                        const userInfo = document.createElement('div');
                        userInfo.classList.add('user-info');

                        const userName = document.createElement('span');
                        userName.innerHTML = "<b>" + data[i].userName + "</b><br>";
                        userInfo.appendChild(userName);

                        const rating = document.createElement('span');
                        rating.textContent = data[i].rating;
                        userInfo.appendChild(rating);

                        offerBlock.appendChild(userInfo);

                        const message = document.createElement('div');
                        message.classList.add('message');
                        message.textContent = data[i].message;
                        offerBlock.appendChild(message);

                        offerContainer.appendChild(offerBlock);
                    }

                } else {
                    console.log('Error:', response.status);
                }
            } catch (error) {
                console.error(error);
            }
        });


        document.addEventListener('DOMContentLoaded', async () => {
            // // only work on single page, not work for DIV shared
            // if (targetTaskID.value === ""){
            // taskID = localStorage.getItem("targetTaskID");
            // } else {
            //     taskID = targetTaskID.value;
            // }

            // this works for Div shared
            taskID = localStorage.getItem("targetTaskID");
            try {
                const response = await fetch(`/getTask/getOfferList?taskID=${taskID}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log(data);
                    console.log(data.length);
                    // for display the raw JSON
                    raw_offerListDisplay.textContent = JSON.stringify(data);

                    // Clear existing content in offerContainer
                    offerContainer.innerHTML = "";


                    for (let i = 0; i < data.length; i++) {
                        const offerBlock = document.createElement('div');
                        offerBlock.classList.add('offer');

                        const userInfo = document.createElement('div');
                        userInfo.classList.add('user-info');

                        const userName = document.createElement('span');
                        userName.innerHTML = "<b>" + data[i].userName + "</b><br>";
                        userInfo.appendChild(userName);

                        const rating = document.createElement('span');
                        rating.textContent = data[i].rating;
                        userInfo.appendChild(rating);

                        offerBlock.appendChild(userInfo);

                        const message = document.createElement('div');
                        message.classList.add('message');
                        message.textContent = data[i].message;
                        offerBlock.appendChild(message);

                        offerContainer.appendChild(offerBlock);
                    }

                } else {
                    console.log('Error:', response.status);
                }
            } catch (error) {
                console.error(error);
            }
        });
    </script> -->

    <script>
        console.log("current target taskID: " + localStorage.getItem("targetTaskID"));
        var offerContainer = document.getElementById("offerContainer");

        function updateOfferContainer() {
            const taskID = localStorage.getItem("targetTaskID");
            if (taskID) {
                fetch(`/getTask/getOfferList?taskID=${taskID}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Error:', response.status);
                        }
                    })
                    .then(data => {
                        console.log(data);
                        console.log(data.length);
                        // // for display the raw JSON
                        // raw_offerListDisplay.textContent = JSON.stringify(data);

                        // Clear existing content in offerContainer
                        offerContainer.innerHTML = "";

                        // handle no offer case
                        if (data.length === 0) {
                            // console.log("no offer");
                            const noOfferText = document.createElement('span');
                            noOfferText.classList.add('noOffer');
                            noOfferText.innerHTML = "This task has no any offers yet.";
                            offerContainer.appendChild(noOfferText);
                        } else {
                            // console.log("has offer");
                            const targetTaskCreatedBy = data[0].createdBy;
                            localStorage.setItem('targetTaskCreatedBy', targetTaskCreatedBy);


                            // choose which template to use !!! A or B
                            if (localStorage.getItem("userID") === localStorage.getItem("targetTaskCreatedBy")) {
                                console.log("choose Template B");
                                function loadCSS(file) {
                                    var link = document.createElement("link");
                                    link.rel = "stylesheet";
                                    link.href = file;
                                    document.head.appendChild(link);
                                }
                                // Load CSS based on your requirements
                                loadCSS("style_offerTemplateB.css");

                                // hand the display of offer in template B - no quotation
                                for (let i = 0; i < data.length; i++) {
                                    const offerBlock = document.createElement('div');
                                    offerBlock.classList.add('offer');

                                    const userInfo = document.createElement('div');
                                    userInfo.classList.add('user-info');

                                    const userName = document.createElement('span');
                                    userName.innerHTML = "<b>" + data[i].userName + "</b><br>";
                                    userInfo.appendChild(userName);

                                    const rating = document.createElement('span');
                                    rating.textContent = "rating: " + data[i].rating;
                                    userInfo.appendChild(rating); 6
                                    offerBlock.appendChild(userInfo);

                                    const message = document.createElement('div');
                                    message.classList.add('message');
                                    message.textContent = data[i].message;
                                    offerBlock.appendChild(message);

                                    const quotation = document.createElement('div');
                                    quotation.classList.add('quotation');
                                    quotation.innerHTML = "quotation<br><h>" + data[i].quotation + "<h3><br>";
                                    const button = document.createElement('button');
                                    button.textContent = 'Select';
                                    quotation.appendChild(button);

                                    offerBlock.appendChild(quotation);

                                    offerContainer.appendChild(offerBlock);
                                }
                            } else {
                                console.log("choose Template A");
                                function loadCSS(file) {
                                    var link = document.createElement("link");
                                    link.rel = "stylesheet";
                                    link.href = file;
                                    document.head.appendChild(link);
                                }
                                // Load CSS based on your requirements
                                loadCSS("style_offerTemplateA.css");

                                // hand the display of offer in template A - no quotation
                                for (let i = 0; i < data.length; i++) {
                                    const offerBlock = document.createElement('div');
                                    offerBlock.classList.add('offer');

                                    const userInfo = document.createElement('div');
                                    userInfo.classList.add('user-info');

                                    const userName = document.createElement('span');
                                    userName.innerHTML = "<b>" + data[i].userName + "</b><br>";
                                    userInfo.appendChild(userName);

                                    const rating = document.createElement('span');
                                    rating.textContent = "rating: " + data[i].rating;
                                    userInfo.appendChild(rating);

                                    offerBlock.appendChild(userInfo);

                                    const message = document.createElement('div');
                                    message.classList.add('message');
                                    message.textContent = data[i].message;
                                    offerBlock.appendChild(message);

                                    offerContainer.appendChild(offerBlock);
                                }
                            };

                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        }

        // use button the change the localStorage targetTaskID
        const changeTargetTaskIDButton = document.getElementById('changeTargetTaskIDButton');
        const targetTaskID = document.getElementById('targetTaskID');
        changeTargetTaskIDButton.addEventListener('click', () => {
            const newTaskID = targetTaskID.value;
            localStorage.setItem('targetTaskID', newTaskID);
            console.log(localStorage);
            updateOfferContainer(); // Update the offerContainer when targetTaskID is changed
        });


        // Listen for changes in the localStorage
        window.addEventListener('storage', (event) => {
            if (event.key === 'targetTaskID') {
                updateOfferContainer();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateOfferContainer();
        });
    </script>


    <script>
        function updateDisplayedSession() {
            const userName = localStorage.getItem('userName');
            const userID = localStorage.getItem('userID');
            const displayElement = document.getElementById('displayStoredSession');
            displayElement.textContent = `User Name: ${userName} | UserID: ${userID}`;
        }
        // Initial display of stored session information
        updateDisplayedSession();
    // // Wait for the sharedDiv to be inserted into the container
    // document.addEventListener('DOMContentLoaded', updateDisplayedSession);
    </script>
</body>

</html>