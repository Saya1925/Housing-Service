<!DOCTYPE html>
<html>

<head>
    <title>subscription function</title>
</head>

<body>
    <span id="example"></span>
    <button id="tryTestDB">testing</button>
    <button onclick="window.location.href='login.html'">Login page</button>
    <button onclick="window.location.href='appTrial.html'">appTrial page</button>
    <button onclick="window.location.href='upgradeAccount.html'">upgrade account page</button>
    <button onclick="window.location.href='makeOffer.html'">Make Offer page</button>
    <button onclick="window.location.href='taskDisplay.html'">Task Display page</button>
    <div id="displayGET"></div>
    <br>
    <span><u>here are the localStorage session data:</u></span><br>
    <span id="displayStoredSession"></span><br>
    <br>
    <br>
    <span><b>taskID value:</b></span>
    <input type="text" id="taskIDInput">
    <button id="fetchCreatedByButton">Fetch Created By</button>
    <span id="createdByDisplay"></span>
    <br>
    <br>
    <span>before submitting the offer, you need to manually enter <br>the target taskID and fetch who created this
        task</span><br>
    <br>

    <style>
        #message {
            width: 276px;
            height: 104px;
            vertical-align: top;
            padding-top: 0px;
        }

        label {
            display: inline-block;
            vertical-align: top;
        }
    </style>
    <form id="offerSubmit" action="/offer/submit-offer" method="POST">
        <label for="message">Message:</label>
        <textarea id="message" name="message"></textarea>
        <br>
        <label for="quotation">Quotation:</label>
        <input type="number" id="quotation" name="quotation" max="20000">
        <br>
        <input type="submit" value="Submit">
    </form>

    <script>
        var targetTaskCreatedBy;
        var targetTaskID;
        // XMLHttpRequest for submit the offer
        document.getElementById('offerSubmit').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const message = offerSubmit.message.value;
            const quotation = offerSubmit.quotation.value;
            const offeredBy = localStorage.getItem('userID');
            const createdBy = targetTaskCreatedBy;
            const taskID = targetTaskID;
            // var message = document.getElementById('message').value;
            // var quotation = document.getElementById('quotation').value;
            console.log(message + " ; " + quotation + " ; " + offeredBy + " ; " + createdBy + " ; " + taskID);
            // var offeredBy = localStorage.getItem('userID');
            // var createdBy = document.getElementById('targetTaskCreatedBy').textContent;
            // var taskID = document.getElementById('targetTaskID').textContent;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/offer/submit-offer');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Offer submitted successfully');
                    // Perform any additional actions upon successful submission
                } else {
                    console.error('Error submitting offer');
                    // Handle the error case
                }
            };

            var formData = JSON.stringify({ message, quotation, offeredBy, createdBy, taskID });
            // const data = JSON.stringify({ email, pw });
            xhr.send(formData);
        });


        // XMLHttpRequest for getting the createdBy
        document.getElementById('fetchCreatedByButton').addEventListener('click', function () {
            targetTaskID = document.getElementById('taskIDInput').value;

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/offer/fetch-created-by?taskID=' + targetTaskID);
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    targetTaskCreatedBy = response.createdBy;
                    document.getElementById('createdByDisplay').textContent = "createdBy(userID): " + targetTaskCreatedBy;
                } else {
                    console.error('Error fetching createdBy');
                    document.getElementById('createdByDisplay').textContent = 'Error fetching createdBy';
                }
            };
            xhr.send();
        });

        /////////// display local store session
        // Function to update the displayed session information
        function updateDisplayedSession() {
            const userName = localStorage.getItem('userName');
            const userID = localStorage.getItem('userID');
            const displayElement = document.getElementById('displayStoredSession');
            displayElement.textContent = `User Name: ${userName} | UserID: ${userID}`;
        }
        // Initial display of stored session information
        updateDisplayedSession();

        // to test the connectivity to DB
        const button_testDB = document.getElementById('tryTestDB');
        button_testDB.addEventListener('click', async () => {
            // console.log("clicked");
            const response = await fetch('/account/test-db');
            const data = await response.json();
            // console.log(data);

            const jsonStr = JSON.stringify(data);
            var displayGet = document.getElementById("displayGET");
            displayGet.innerHTML = data[0].email +
                " : <br> the userID for this account is =>" + data[0].userID +
                " <br> the user first name: " + data[0].sname +
                " <br> the user last name: " + data[0].lname;
        });
    </script>
</body>

</html>